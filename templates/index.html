<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgenticVerifier Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; padding: 0; color: #111; }
    header { padding: 16px 24px; background: #0f172a; color: #fff; }
    main { padding: 16px 24px; display: grid; gap: 24px; grid-template-columns: 320px 1fr; }
    .panel { background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    .rounds ul { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 8px; }
    .rounds a { display: block; padding: 8px 10px; text-decoration: none; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; text-align: center; color: #0f172a; }
    .rounds a:hover { background: #eef2ff; border-color: #c7d2fe; }
    pre { white-space: pre-wrap; word-break: break-word; background: #fff; border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px; max-height: 420px; overflow: auto; }
    h2 { margin: 0 0 12px; font-size: 18px; }
    .meta { color: #475569; font-size: 12px; }
    /* Message styling */
    #generatorList { display: flex; flex-direction: column; gap: 12px; }
    .msg { border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; padding: 12px; }
    .msg .meta { margin-bottom: 6px; }
    .bubble { font-size: 14px; line-height: 1.45; color: #111; }
    .bubble img { max-width: 100%; height: auto; display: block; margin: 6px 0; }
    /* Tool calls */
    .tool-calls { margin-top: 8px; border-top: 1px dashed #e5e7eb; padding-top: 8px; }
    .tool-calls > .title { font-weight: 600; font-size: 12px; color: #334155; margin-bottom: 6px; }
    .tool-call { border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; padding: 8px; margin-bottom: 8px; }
    .tool-call .tool-head { font-weight: 600; font-size: 13px; color: #0f172a; margin-bottom: 6px; }
    .tool-call pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; line-height: 1.5; background: #fff; max-height: 260px; }
  </style>
  <script type="application/json" id="generatorData">{{ generator | tojson }}</script>
  <script>
    // Prefix for static data depending on selected dataset
    const DATA_PREFIX = {{ (data_prefix or '/data1') | tojson | safe }};
  </script>
  <script>
    function prefixDataPath(url) {
      if (!url) return url;
      const isAbsolute = /^(https?:)?\/\//i.test(url) || url.startsWith('data:');
      const isRooted = url.startsWith('/');
      return (isAbsolute || isRooted) ? url : (DATA_PREFIX + '/' + url.replace(/^\.\/?/, ''));
    }

    function guessMimeFromBase64(b64) {
      if (!b64) return 'image/png';
      const head = b64.slice(0, 5);
      if (b64.startsWith('/9j/')) return 'image/jpeg';
      if (b64.startsWith('iVBOR')) return 'image/png';
      if (b64.startsWith('R0lGO')) return 'image/gif';
      if (b64.startsWith('UklGR')) return 'image/webp';
      return 'image/png';
    }

    function normalizeImageUrl(imageUrl) {
      if (!imageUrl) return null;
      let url = imageUrl;
      if (typeof imageUrl === 'object' && imageUrl.url) url = imageUrl.url;
      if (!url) return null;
      if (url.startsWith('data:')) return url;
      const base64Like = /^[A-Za-z0-9+/=]+$/.test(url) && (url.length > 64);
      if (base64Like) {
        const mime = guessMimeFromBase64(url);
        return `data:${mime};base64,${url}`;
      }
      return prefixDataPath(url);
    }

    function renderTextWithImages(text) {
      if (!text) return '';
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      html = html.replace(/!\[[^\]]*\]\(([^)]+)\)/g, (m, p1) => {
        const src = prefixDataPath(p1.trim());
        return '<img src="' + src + '" alt="image" />';
      });
      html = html.replace(/(\S+\.(?:png|jpg|jpeg|gif|webp))/gi, (m) => {
        const src = prefixDataPath(m);
        return '<img src="' + src + '" alt="image" />';
      });
      html = html.replace(/\n/g, '<br/>');
      return html;
    }

    function tryParseJson(maybeJson) {
      if (maybeJson == null) return null;
      if (typeof maybeJson === 'object') return maybeJson;
      if (typeof maybeJson !== 'string') return null;
      try { return JSON.parse(maybeJson); } catch { return null; }
    }

    function normalizeToolCalls(msg) {
      const calls = [];
      if (!msg) return calls;
      // OpenAI-style tool_calls: [{ id, type: 'function', function: { name, arguments } }]
      if (Array.isArray(msg.tool_calls)) {
        msg.tool_calls.forEach((tc, idx) => {
          if (!tc) return;
          if (tc.function && (tc.function.name || tc.function.arguments != null)) {
            calls.push({
              name: tc.function.name || 'function',
              id: tc.id || null,
              arguments: tc.function.arguments
            });
          } else if (tc.type && tc.name) {
            calls.push({ name: tc.name, id: tc.id || null, arguments: tc.arguments || tc.args || null });
          }
        });
      }
      // Some providers embed a single tool call on the message root
      if (!calls.length && (msg.tool_call || msg.tool_name)) {
        calls.push({ name: msg.tool_name || 'tool', id: msg.tool_call_id || null, arguments: msg.tool_call_arguments || msg.arguments || null });
      }
      return calls;
    }

    function renderToolCallsSection(msg) {
      const calls = normalizeToolCalls(msg);
      if (!calls.length) return null;
      const wrapper = document.createElement('div');
      wrapper.className = 'tool-calls';
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = 'Tool calls';
      wrapper.appendChild(title);
      calls.forEach((call, i) => {
        const item = document.createElement('div');
        item.className = 'tool-call';
        const head = document.createElement('div');
        head.className = 'tool-head';
        const label = call.name ? call.name : 'tool';
        head.textContent = label + (call.id ? ('  [' + call.id + ']') : '');
        item.appendChild(head);
        const pre = document.createElement('pre');
        const parsed = tryParseJson(call.arguments);
        try {
          pre.textContent = parsed != null ? JSON.stringify(parsed, null, 2) : String(call.arguments ?? '');
        } catch {
          pre.textContent = String(call.arguments ?? '');
        }
        item.appendChild(pre);
        wrapper.appendChild(item);
      });
      return wrapper;
    }

    function renderMessageContent(msg) {
      const container = document.createElement('div');
      container.className = 'bubble';
      const content = msg && (msg.content || msg.text || msg.message);
      if (Array.isArray(content)) {
        content.forEach(part => {
          if (!part) return;
          if (part.type === 'text' || typeof part === 'string') {
            const div = document.createElement('div');
            div.innerHTML = renderTextWithImages(String(part.text || part));
            container.appendChild(div);
          } else if (part.type === 'image_url' || part.image_url) {
            const src = normalizeImageUrl(part.image_url || part.url);
            if (src) {
              const img = document.createElement('img');
              img.src = src;
              img.alt = 'image';
              img.style.maxWidth = '100%';
              container.appendChild(img);
            }
          }
        });
      } else if (content && typeof content === 'object') {
        if (content.image_url || content.images) {
          const maybeUrls = [];
          if (content.image_url) maybeUrls.push(content.image_url);
          if (Array.isArray(content.images)) maybeUrls.push(...content.images);
          maybeUrls.forEach(u => {
            const src = normalizeImageUrl(u);
            if (src) {
              const img = document.createElement('img');
              img.src = src;
              img.alt = 'image';
              img.style.maxWidth = '100%';
              container.appendChild(img);
            }
          });
        }
        if (content.text) {
          const div = document.createElement('div');
          div.innerHTML = renderTextWithImages(String(content.text));
          container.appendChild(div);
        }
      } else {
        const div = document.createElement('div');
        div.innerHTML = renderTextWithImages(String(content || ''));
        container.appendChild(div);
      }
      // For assistant messages, also render tool calls if present
      const role = msg && (msg.role || msg.speaker || msg.name);
      if (role && String(role).toLowerCase() === 'assistant') {
        const toolsEl = renderToolCallsSection(msg);
        if (toolsEl) container.appendChild(toolsEl);
      }
      return container;
    }

    function tryGetMessages(generatorJson) {
      if (!generatorJson) return [];
      if (Array.isArray(generatorJson)) return generatorJson;
      if (Array.isArray(generatorJson.messages)) return generatorJson.messages;
      if (Array.isArray(generatorJson.conversation)) return generatorJson.conversation;
      return [];
    }

    document.addEventListener('DOMContentLoaded', () => {
      let data = null;
      try { data = JSON.parse(document.getElementById('generatorData').textContent || 'null'); } catch {}
      const messages = tryGetMessages(data);
      const list = document.getElementById('generatorList');
      const fallback = document.getElementById('generatorPre');
      if (messages.length > 0) {
        fallback.style.display = 'none';
        messages.forEach((msg, idx) => {
          const role = (msg && (msg.role || msg.speaker || msg.name)) || 'message';
          const item = document.createElement('div');
          item.className = 'msg';
          const header = document.createElement('div');
          header.className = 'meta';
          header.innerHTML = '<strong>' + role + '</strong>';
          item.appendChild(header);
          item.appendChild(renderMessageContent(msg));
          list.appendChild(item);
        });
      } else {
        try { fallback.textContent = JSON.stringify(data, null, 2); } catch {}
      }
    });
  </script>
  </head>
<body>
  <header>
    <h1>AgenticVerifier Viewer</h1>
    <div class="meta">Data root: {{ data_root }}</div>
  </header>
  <main>
    <section class="panel rounds">
      <h2>Datasets</h2>
      <div id="datasetButtons" style="display: grid; grid-template-columns: 1fr; gap: 8px;"></div>
      <script>
        (function() {
          function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
          }
          function makeButton(label, value, isActive) {
            const a = document.createElement('a');
            a.textContent = label && label.trim().length ? label : '(empty)';
            a.href = '/?dataset=' + encodeURIComponent(value || '');
            a.style.display = 'block';
            a.style.padding = '8px 10px';
            a.style.textDecoration = 'none';
            a.style.background = isActive ? '#eef2ff' : '#fff';
            a.style.border = '1px solid ' + (isActive ? '#c7d2fe' : '#e5e7eb');
            a.style.borderRadius = '6px';
            a.style.textAlign = 'center';
            a.style.color = '#0f172a';
            a.addEventListener('mouseover', function() {
              if (!isActive) {
                a.style.background = '#eef2ff';
                a.style.borderColor = '#c7d2fe';
              }
            });
            a.addEventListener('mouseout', function() {
              if (!isActive) {
                a.style.background = '#fff';
                a.style.borderColor = '#e5e7eb';
              }
            });
            return a;
          }
          const selected = getQueryParam('dataset') || {{ (selected_dataset_index or '1') | tojson | safe }};
          const container = document.getElementById('datasetButtons');
          const datasets = ({{ datasets | tojson | safe }} || []);
          datasets.forEach(function(ds) {
            const name = ds && ds.name ? ds.name : '';
            const idx = ds && ds.index ? ds.index : '';
            const btn = makeButton(name, idx, idx && idx === selected);
            container.appendChild(btn);
          });
        })();
      </script>
    </section>
    <section class="panel">
      <h2>Generator Thoughts</h2>
      <div id="generatorList"></div>
      <pre id="generatorPre"></pre>
    </section>
  </main>
</body>
</html>




